# Multi-stage build for rust-analyzer
ARG VERSION=2025-12-15
FROM rust:slim-bookworm AS builder
ARG VERSION
RUN apt-get update && apt-get install -y curl && rm -rf /var/lib/apt/lists/*

# Determine architecture and download appropriate binary
# rust-analyzer releases use x86_64-unknown-linux-gnu or aarch64-unknown-linux-gnu
RUN set -eux; \
    arch=$(uname -m); \
    case "$arch" in \
        x86_64) bin="rust-analyzer-x86_64-unknown-linux-gnu.gz" ;; \
        aarch64) bin="rust-analyzer-aarch64-unknown-linux-gnu.gz" ;; \
        *) echo "Unsupported architecture: $arch"; exit 1 ;; \
    esac; \
    curl -L "https://github.com/rust-lang/rust-analyzer/releases/download/${VERSION}/${bin}" | gunzip -c - > /usr/local/bin/rust-analyzer; \
    chmod +x /usr/local/bin/rust-analyzer

FROM gcr.io/distroless/cc-debian12
ARG VERSION
LABEL org.opencontainers.image.version="${VERSION}"

COPY --from=builder /usr/local/bin/rust-analyzer /usr/local/bin/rust-analyzer

WORKDIR /workspace
ENTRYPOINT ["/usr/local/bin/rust-analyzer"]

